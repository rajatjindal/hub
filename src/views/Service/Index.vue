<template>
  <div class="has-background-light section">
    <a-section
      large-header
      divider-content="CONTRIBUTORS"
      divider-align="right">
      <template slot="header-left">
        <svg
          width="80px"
          height="80px"
          viewBox="0 0 80 80"
          version="1.1"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:xlink="http://www.w3.org/1999/xlink">
          <g
            id="HUB"
            stroke="none"
            stroke-width="1"
            fill="none"
            fill-rule="evenodd">
            <g
              id="3.Hub---feature_detail-ACTION"
              transform="translate(-154.000000, -150.000000)">
              <g
                id="Group-4-Copy-8"
                transform="translate(154.000000, 150.000000)">
                <rect
                  id="Rectangle"
                  fill="#4A154B"
                  fill-rule="nonzero"
                  x="0"
                  y="0"
                  width="80"
                  height="80"
                  rx="10"/>
                <g
                  id="Group-2"
                  transform="translate(21.728395, 20.740741)">
                  <path
                    id="Fill-15"
                    d="M8.13168724,25.5558674 C8.13168724,27.8991813 6.31168724,29.7991943 4.06584362,29.7991943 C1.82106996,29.7991943 -4.61852778e-14,27.8991813 -4.61852778e-14,25.5558674 C-4.61852778e-14,23.2125536 1.82106996,21.3125406 4.06584362,21.3125406 L8.13168724,21.3125406 L8.13168724,25.5558674 Z"
                    fill="#E01E5A"/>
                  <path
                    id="Fill-17"
                    d="M9.62962963,25.5558674 C9.62962963,23.2125536 11.4496296,21.3125406 13.6954733,21.3125406 C15.9402469,21.3125406 17.7613169,23.2125536 17.7613169,25.5558674 L17.7613169,36.1641845 C17.7613169,38.5074984 15.9402469,40.4075114 13.6954733,40.4075114 C11.4496296,40.4075114 9.62962963,38.5074984 9.62962963,36.1641845 L9.62962963,25.5558674 Z"
                    fill="#E01E5A"/>
                  <path
                    id="Fill-19"
                    d="M14.2297037,8.48654711 C11.9838601,8.48654711 10.1638601,6.58653411 10.1638601,4.24322027 C10.1638601,1.89990643 11.9838601,-0.000106562703 14.2297037,-0.000106562703 C16.4755473,-0.000106562703 18.2955473,1.89990643 18.2955473,4.24322027 L18.2955473,8.48654711 L14.2297037,8.48654711 Z"
                    fill="#36C5F0"/>
                  <path
                    id="Fill-21"
                    d="M14.2297037,10.6083171 C16.4755473,10.6083171 18.2955473,12.5083301 18.2955473,14.8516439 C18.2955473,17.1949578 16.4755473,19.0949708 14.2297037,19.0949708 L4.06509465,19.0949708 C1.82032099,19.0949708 0.000320987654,17.1949578 0.000320987654,14.8516439 C0.000320987654,12.5083301 1.82032099,10.6083171 4.06509465,10.6083171 L14.2297037,10.6083171 Z"
                    fill="#36C5F0"/>
                  <path
                    id="Fill-23"
                    d="M29.9588477,14.8995971 C29.9588477,12.5562833 31.7788477,10.6562703 34.0246914,10.6562703 C36.269465,10.6562703 38.090535,12.5562833 38.090535,14.8995971 C38.090535,17.242911 36.269465,19.142924 34.0246914,19.142924 L29.9588477,19.142924 L29.9588477,14.8995971 Z"
                    fill="#2EB67D"/>
                  <path
                    id="Fill-25"
                    d="M28.4609053,14.8516439 C28.4609053,17.1949578 26.6409053,19.0949708 24.3950617,19.0949708 C22.1502881,19.0949708 20.3292181,17.1949578 20.3292181,14.8516439 L20.3292181,4.24332684 C20.3292181,1.900013 22.1502881,1.77635684e-15 24.3950617,1.77635684e-15 C26.6409053,1.77635684e-15 28.4609053,1.900013 28.4609053,4.24332684 L28.4609053,14.8516439 Z"
                    fill="#2EB67D"/>
                  <path
                    id="Fill-27"
                    d="M24.3937778,31.8246316 C26.6396214,31.8246316 28.4596214,33.7246446 28.4596214,36.0679584 C28.4596214,38.4112723 26.6396214,40.3112853 24.3937778,40.3112853 C22.1479342,40.3112853 20.3279342,38.4112723 20.3279342,36.0679584 L20.3279342,31.8246316 L24.3937778,31.8246316 Z"
                    fill="#ECB22E"/>
                  <path
                    id="Fill-29"
                    d="M24.3715213,29.8375569 C22.1386806,29.8375569 20.3292181,28.1675304 20.3292181,26.1078622 C20.3292181,24.0481941 22.1386806,22.3781676 24.3715213,22.3781676 L34.4762154,22.3781676 C36.709056,22.3781676 38.5185185,24.0481941 38.5185185,26.1078622 C38.5185185,28.1675304 36.709056,29.8375569 34.4762154,29.8375569 L24.3715213,29.8375569 Z"
                    fill="#ECB22E"/>
                </g>
              </g>
            </g>
          </g>
        </svg>
      </template>
      <template slot="header-centered">
        <h5 class="is-size-4 has-text-weight-bold has-text-dark">SLACK Service</h5>
        <span class="is-size-8 has-text-weight-bold has-text-uppercase has-text-gray-3">microservice/slack</span>
      </template>
      <template slot="header-right">
        <a-input
          :icon-right="['a-icon', { icon: 'search' }]"
          class="has-background-light"
          placeholder="SEARCH DOCS"
        />
      </template>
      <template slot="header-divider-content-right">
        <span class="tag is-primary">+10</span>
      </template>
      <p class="is-size-7 has-text-dark has-text-uppercase has-text-weight-bold">Version 0.1.3 - MIT LICENSED</p>
      <div class="columns">
        <div class="column is-one-third">
          <p class="is-size-8 has-text-gray-3 has-text-weight-bold has-text-uppercase">Service Used in N Stories</p>
          <div class="image is-3by2">
            <img
              src="@/assets/img/services/metrics/1.png"
              srcset="@/assets/img/services/metrics/1@2x.png 2x, @/assets/img/services/metrics/1@3x.png 3x"
              alt="services used">
          </div>
        </div>
        <div class="column is-one-third">
          <p class="is-size-8 has-text-gray-3 has-text-weight-bold has-text-uppercase">Health</p>
          <div class="image is-3by2">
            <img
              src="@/assets/img/services/metrics/2.png"
              srcset="@/assets/img/services/metrics/2@2x.png 2x, @/assets/img/services/metrics/2@3x.png 3x"
              alt="health">
          </div>
        </div>
        <div class="column is-one-third">
          <p class="is-size-8 has-text-gray-3 has-text-weight-bold has-text-uppercase">Steps</p>
          <div class="image is-3by2">
            <img
              src="@/assets/img/services/metrics/3.png"
              srcset="@/assets/img/services/metrics/3@2x.png 2x, @/assets/img/services/metrics/3@3x.png 3x"
              alt="steps">
          </div>
        </div>
      </div>
    </a-section>
    <section class="hero bg--dark is-medium">
      <div class="hero-body">
        <div class="container">
          <stars-particles />
          <div class="title-container">
            <div class="columns">
              <div class="column is-one-fifth avatar-container">
                <div class="avatar">
                  <img
                    src="@/assets/slack.png"
                    alt="Slack">
                </div>
              </div>
              <div class="column is-four-fifths main-head">
                <h1
                  v-if="serviceName"
                  class="title is-1 text--light">{{ serviceName | capitalize }} service</h1>
                <h1
                  v-else
                  class="title is-1 text--light">...</h1>
                <transition name="fade">
                  <h3
                    v-if="service.description"
                    class="subtitle is-4 text--light">{{ service.description | emoji }}</h3>
                  <h3
                    v-else-if="!service.description && serviceName"
                    class="subtitle is-4 none-found text--light">This service has no description.</h3>
                  <h3
                    v-else
                    class="subtitle is-4 description">...</h3>
                </transition>
                <div class="service-categories">
                  <services-icon
                    type="popular"
                    light />
                  <services-icon
                    type="messaging"
                    light />
                  <services-icon
                    type="worker"
                    light />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg--darker">
        <div class="info-container">
          <div class="columns is-multiline">
            <div class="column is-full">
              <h4 class="version">Version {{ latestVersion || 'unknown' }} &middot; {{ license || 'No license' }}</h4>
              <p class="publication">Last published 5 minutes ago</p>
            </div>
            <div class="column is-one-third">
              <h5>Monthly usage<span class="float-right">153 users</span></h5>
              <div class="trend">
                <la-cartesian
                  :width="300"
                  :height="150"
                  :bound="[0]"
                  :data="[{ v: 1 }, { v: 1 }, { v: 1 }, { v: 3 }, { v: 1 }, { v: 3 }, { v: 5 }, { v: 9 }, { v: 5 }, { v: 10 }, { v: 3 }, { v: 5 }]"
                  :padding="0"
                  autoresize>
                  <defs>
                    <linearGradient
                      id="colorm-fill"
                      x1="0"
                      y1="0"
                      x2="0"
                      y2="1">
                      <stop
                        stop-color="#a100ff"
                        offset="0%" />
                      <stop
                        stop-color="#efefef"
                        offset="100%" />
                    </linearGradient>
                  </defs>
                  <la-line
                    :width="2"
                    curve
                    prop="v"
                    color="url(#colorm-fill)" />
                </la-cartesian>
              </div>
            </div>
            <div class="column is-one-third">
              <h5>Successful builds<span class="float-right">2,567 builds</span></h5>
              <div class="trend">
                <la-cartesian
                  :width="300"
                  :height="150"
                  :bound="[0]"
                  :data="[{ v: 10 }, { v: 5 }, { v: 7 }, { v: 6 }, { v: 20 }, { v: 15 }, { v: 30 }]"
                  :padding="0"
                  autoresize>
                  <defs>
                    <linearGradient
                      id="area-fill"
                      x1="0"
                      y1="0"
                      x2="0"
                      y2="1">
                      <stop
                        stop-color="#0e0f12"
                        offset="0%"
                        stop-opacity="0.8" />
                      <stop
                        stop-color="#0e0f12"
                        offset="100%"
                        stop-opacity="0.4" />
                    </linearGradient>
                  </defs>
                  <defs>
                    <linearGradient
                      id="color-fill"
                      x1="0"
                      y1="0"
                      x2="0"
                      y2="1">
                      <stop
                        stop-color="#f72d2d"
                        offset="0%" />
                      <stop
                        stop-color="#ff7900"
                        offset="100%" />
                    </linearGradient>
                  </defs>
                  <la-area
                    :width="2"
                    fill-color="url(#area-fill)"
                    line
                    color="url(#color-fill)"
                    curve
                    prop="v"/>
                </la-cartesian>
              </div>
            </div>
            <div class="column is-one-third">
              <!-- <div id="heatmap" /> -->
            </div>
          </div>
        </div>
      </div>
    </section>
    <div class="section">
      <div class="container breadcrumb-container">
        <div class="columns">
          <div class="column is-full">
            <transition name="fade">
              <nav
                class="breadcrumb"
                aria-label="breadcrumbs">
                <ul>
                  <li><router-link :to="{ name: 'hub' }">Hub</router-link></li>
                  <li><router-link :to="{ name: 'services' }">Services</router-link></li>
                  <li
                    v-if="$route.name.includes('service')"
                    class="is-active"><a
                      :aria-current="serviceName"
                      href="#"
                      @click.stop="">{{ serviceName | capitalize }}</a></li>
                  <template v-else>
                    <li><router-link :to="{ name: `service${$route.name === 'guide' ? '' : '_repo'}`, params: ($route.name === 'guide' ? { alias } : { owner, repo }), hash: '' }">{{ serviceName | capitalize }}</router-link></li>
                    <li><router-link :to="{ name: `service${$route.name === 'guide' ? '' : '_repo'}`, params: ($route.name === 'guide' ? { alias } : { owner, repo }), hash: '#actions' }">Actions</router-link></li>
                    <li
                      v-for="(cat, idx) of getHashArray"
                      :key="`breadcrumbs-${cat}`"
                      :class="{ 'is-active': idx === getHashArray.length - 1 }">
                      <a
                        :href="`#${getHash(idx)}`"
                        :aria-current="`${serviceName} guide ${cat}`"
                        @click.stop="$router.push({name: $route.name, params: $route.params, hash: `#${getHash(idx)}` })">{{ cat }}</a>
                    </li>
                  </template>
                </ul>
              </nav>
            </transition>
          </div>
        </div>
      </div>
    </div>
    <transition name="fade">
      <router-view />
    </transition>
  </div>
</template>

<script>
import { ServiceQuery, ServiceByOwnerAndRepoQuery } from '@/plugins/graphql'
import ServicesIcon from '@/components/ServicesIcon'
import ASection from '@/components/ASection'

export default {
  name: 'Integration',
  components: {
    ServicesIcon,
    ASection
  },
  props: {
    repo: {
      type: String,
      default: undefined
    },
    alias: {
      type: String,
      default: undefined
    },
    owner: {
      type: String,
      default: undefined
    }
  },
  apollo: {
    serviceByAlias: {
      query: ServiceQuery,
      skip: function () {
        return !this.alias
      },
      variables: function () {
        return {
          where: this.alias
        }
      },
      update: function (data) {
        return data.serviceByAlias
      }
    },
    serviceByOwnerAndRepo: {
      query: ServiceByOwnerAndRepoQuery,
      skip: function () {
        return !this.owner && !this.repo
      },
      variables: function () {
        return {
          owner: this.owner,
          repo: this.repo
        }
      },
      update: function (data) {
        return (
          data.allOwners.nodes.length > 0 &&
          data.allOwners.nodes[0].services.nodes.length > 0 &&
          data.allOwners.nodes[0].services.nodes[0]
        )
      }
    }
  },
  data: () => ({
    serviceByAlias: undefined,
    serviceByOwnerAndRepo: undefined,
    startDate: new Date('2018-05-30T12:10:30.407+05:30'),
    endDate: new Date()
  }),
  computed: {
    service: function () {
      return this.serviceByAlias || this.serviceByOwnerAndRepo || {}
    },
    getHashArray: function () {
      return ((this.$route.hash || '').split('#') || ['', ''])[1].split('-')
    },
    serviceName: function () {
      if (
        !this.service.alias &&
        (!this.service || !this.service.owner)
      ) {
        return ''
      }
      return (
        this.service.alias ||
        `${this.service.owner.username}/${this.service.name}`
      )
    },
    numCommands: function () {
      return Object.keys(this.commands).length
    },
    commands: function () {
      return (
        (this.service &&
          this.service.serviceTags &&
          this.service.serviceTags.nodes &&
          this.service.serviceTags.nodes.length > 0 &&
          this.service.serviceTags.nodes[0].configuration.actions) ||
        {}
      )
    },
    tags: function () {
      return (
        (this.service &&
          this.service.serviceTags &&
          this.service.serviceTags.nodes) ||
        []
      )
    },
    license: function () {
      return ((this.tags && this.tags.length > 0 &&
                this.tags[0].configuration &&
                this.tags[0].configuration.info &&
                this.tags[0].configuration.info.license &&
                this.tags[0].configuration.info.license.name) || undefined)
    },
    latestVersion: function () {
      return ((this.tags && this.tags.length > 0 &&
          this.tags[0].configuration &&
          this.tags[0].configuration.info &&
          this.tags[0].configuration.info.version) || undefined)
    }
  },
  watch: {
    '$route': function () {
      this.$nextTick(this.onReady)
    },
    serviceByAlias: function (newValue) {
      if (!newValue) this.$router.push('/404')
      else this.onReady()
    },
    serviceByOwnerAndRepo: function (newValue) {
      if (!newValue) this.$router.push('/404')
      else this.onReady()
    }
  },
  mounted: function () {
    // this.chart = new Chart('#heatmap', {
    //   type: 'heatmap',
    //   data: {
    //     dataPoints: {
    //       '1536761433': 8,
    //       '1534083033': 4,
    //       '1535432233': 2,
    //       '1535639233': 1,
    //       '1536349233': 9,
    //       '1534940333': 5
    //     },
    //     start: this.startDate,
    //     end: this.endDate
    //   },
    //   countLabel: 'crashs',
    //   discreteDomains: 0, // default: 1
    //   colors: ['#ebccff', '#d799ff', '#c466ff', '#b032ff', '#a100ff']
    // })
  },
  methods: {
    onReady: function (callback) {
      if (callback) {
        this.onReadyCallback = callback
      } else {
        if (this.onReadyCallback) {
          this.onReadyCallback()
        }
      }
    },
    getHash: function (idx) {
      let hash = ((this.$route.hash || '').split('#') || ['', ''])[1].split('-')
      hash.splice(idx + 1)
      return hash.join('-')
    }
  }
}
</script>

<style lang="scss">
.body-section {
  &:first-child {
    .heading-title {
      margin-top: 0 !important;
    }
  }
  .heading-title {
    margin-top: 1.5rem !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
  }
}

.bg--darker {
  background-color: rgba(darken($dark, 10%), .5);
}

.info-container {
  padding: 3rem 2rem;
  max-width: 1440px;
  width: 100%;
  margin: 0 auto;
  position: relative;
  color: $white;

  .version {
    padding-bottom: .5rem !important;
  }

  .publication {
    color: gray(400);
  }
}

.float-right {
  float: right;
}

.breadcrumb-container {
  @include desktop { height: 3rem }
  padding-top: 1.5rem !important;
  padding-bottom: 0 !important;
}

.trend {
  svg {
    border: 1px solid gray(800);
    border-radius: .25rem;
    padding: 0;
    background-color: rgba(darken($dark, 5%), 1);
  }
}

.title-container {
  max-width: 1440px;
  width: 100%;
  padding: 0 2rem !important;
  margin: 0 auto !important;
  z-index: 2;

  .main-head {
    h1, h3 {
      margin-bottom: 0 !important;
      padding-bottom: 1rem !important;
    }
    .service-categories {
      svg + svg {
        margin-left: 1rem;
      }
    }
  }

  .avatar-container {
    display: flex !important;
    align-items: center;
    justify-content: flex-end;
  }

  .avatar {
    width: 100%;
    max-width: 128px;
    height: 128px;
    border-radius: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: $white;
    padding: 0;
    z-index: 1;
    box-shadow: 0 .3rem 2rem .1rem rgba(darken($dark, 15%), .5);
    overflow: hidden;
    img {
      padding: 1rem;
    }
    .picture {
      border: .3rem solid $white;
      border-radius: 100%;
      margin: 0;
      width: 128px;
      height: 128px;
      background-size: cover;
      background-position: center center;
    }
  }
}

.toc-commands {
  tbody {
    tr {
      margin-bottom: .5rem;
      &:not(:last-child) {
        border-bottom: 1px solid gray(200);
      }
      td {
        &:first-child {
          padding: 1rem 3rem 1rem 0;
        }
        padding: 1rem 2rem 1rem 0 !important;
        max-width: 20rem;
        @include mobile {
          max-width: 130px;
        }
        @include touch {
          max-width: 15rem;
        }
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
      }
    }
  }
}

.index {
  background-color: #fff;
}

.bordered {
  border: 0.0625rem solid rgba(0, 0, 0, 0.05);
}

.img-collabs {
  border: 3px solid #fff;
  &:not(:first-child) {
    margin-left: -15px;
  }
}

.version-head {
  font-family: Inconsolata, Arial, Verdana, Tahoma, sans-serif;

  &:not(:first-child) {
    margin-top: 20px;
  }
}

.sticky-sidebar {
  position: sticky !important;
  top: 5.5rem !important;
  .sidebar-stick {
    // margin-top: 5rem !important;
  }
}

.sidebar-info {
  font-size: 0.95em;

  .section:not(:first-child) {
    margin-top: 1.2em;
  }

  a:not(:first-child) {
    button {
      margin-top: 10px;
    }
  }

  .links,
  .versions {
    margin-top: 0;
    list-style: none;
    padding-left: 0;

    button:not(:first-child) {
      margin-top: 20px;
    }
  }
  button {
    // text-align: left;
  }
}

.none-found {
  font-size: 0.9em;
  color: #aaa;
}

.body {
  max-width: 800px;

  & > .body-section {

    &:not(:first-child) {
      margin-top: 1.8em;
    }

    p {
      margin: 0;
      font-size: 0.95em;
    }
  }

  .name-container {
    margin-bottom: 1.5em;
    line-height: 2.8em;

    h1 {
      margin-bottom: 0;
    }

    .checkmark {
      margin-left: 0.8em;
      font-size: 2em;
      color: #3e87da;
    }
  }
}
</style>
